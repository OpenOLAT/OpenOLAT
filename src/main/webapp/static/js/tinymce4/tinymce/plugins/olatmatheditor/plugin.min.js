/**
 * The math editor plugin offers a latex-formula real-time authoring environment.
 * See how it looks as you type. The plugin uses MathJax to format the tex formulas.
 * 
 * 18.06.2009 timo.wuersch@frentix.com
 */
(function() {
    'use strict'; 
    
    var global$2 = tinymce.util.Tools.resolve('tinymce.PluginManager');
    
    var cachedTrans;
	var cachedCoreTrans;
	var MathJax = window.MathJax;
	// Load the OLAT translator.
	function translator() {	
		if(cachedTrans) return cachedTrans;
		var mainWin = o_getMainWin();
		if (mainWin) {
			cachedTrans = jQuery(document).ooTranslator().getTranslator(mainWin.o_info.locale, 'org.olat.core.gui.components.form.flexible.impl.elements.richText.plugins.olatmatheditor')	
		} else {
			cachedTrans = {	translate : function(key) { return key; } }
		}
		return cachedTrans;
	}
	
	function coreTranslator() {	
		if(cachedCoreTrans) return cachedCoreTrans;
		var mainWin = o_getMainWin();
		if (mainWin) {
			cachedCoreTrans = jQuery(document).ooTranslator().getTranslator(mainWin.o_info.locale, 'org.olat.core');
		} else {
			cachedCoreTrans = {	translate : function(key) { return key; } }
		}
		return cachedCoreTrans;
	}
    
    function isLatexElement(element) {
		return element.hasAttribute('data-mathtex');
	}
    
	/**
	 * Initializes the plugin, this will be executed after the plugin has been created.
	 * This call is done before the editor instance has finished it's initialization so use the onInit event
	 * of the editor instance to intercept that event.
	 *
	 * @param {tinymce.Editor} ed Editor instance that the plugin is initialized in.
	 * @param {string} url Absolute URL to where the plugin is located.
	 */
	var register = function (editor, url) {
			
		var insertLatex = function(dialogApi, contentNode) {
	        var tex = dialogApi.getData().latex;
	        // Check whether the selection is a jsMath objet by looking at its class attribute
	        if ((contentNode != null) && (/math/.test(editor.dom.getAttrib(contentNode, "class")))) {
	        	if(tex == null || tex.length == 0) {
	        		editor.dom.remove(contentNode);
	        	} else {
	            	editor.dom.setAttrib(contentNode, "data-mathtex", tex);
	            	editor.dom.setAttrib(contentNode, "data-mce-placeholder", "latex")
	            	editor.dom.setAttrib(contentNode, 'title', escape(tex));
	            	contentNode.innerHTML = tex;
	            	checkElement(contentNode);
	            }
	            editor.execCommand("mceRepaint");
				editor.setDirty(true);
	        } else if(tex != null && tex.length > 0) {
	            var newElement = editor.getDoc().createElement('span');
          		newElement.innerHTML = tex;
	            newElement.setAttribute("data-mathtex", tex);
	            newElement.setAttribute("data-mce-placeholder", "latex")
	            newElement.setAttribute('title', escape(tex));
				newElement.classList.add('math');
				checkElement(newElement);
				editor.insertContent(newElement.outerHTML);
	        }
	        
	        editor.getDoc().defaultView.MathJax.startup.getComponents();
        	editor.getDoc().defaultView.MathJax.typeset();
	        
			var mf = document.getElementById('mathlive');
			if(mf) {
				mf.executeCommand("hideVirtualKeyboard");
			}
	        dialogApi.close();
		};
		
		var closeKeyboardLatex = function() {
			var mf = document.getElementById('mathlive');
			if(mf) {
				mf.executeCommand("hideVirtualKeyboard");
			}
		};
		
		var checkElement = function(element) {
			if (element.childNodes.length != 2) {
				element.setAttribute('contenteditable', false);
				element.style.cursor = 'pointer';
				var latex = element.getAttribute('data-mathtex') || element.innerHTML;
				element.setAttribute('data-mathtex', latex);
				element.setAttribute('data-mce-placeholder', 'latex');
				element.innerHTML = '';

				var math = editor.dom.create('span');
				if(latex.indexOf('$') == 0 || latex.indexOf('\(') == 0 || latex.indexOf('[[') == 0) {
					math.innerHTML = latex;
				} else {
					math.innerHTML = '$' + latex + '$';
				}
				math.classList.add('math-original');
				element.appendChild(math);

				var dummy = editor.dom.create('span');
				dummy.classList.add('dummy');
				dummy.innerHTML = 'dummy';
				dummy.setAttribute('hidden', 'hidden');
				element.appendChild(dummy);
			}
		};
			
		function showDialog() {
		
			var data = {
				latex: ''
			};
			
			var selectedNode = editor.selection.getNode();
	        if ((selectedNode.nodeName.toLowerCase() == "span") && (selectedNode.className.indexOf("math") >= 0)) {
				data.latex = jQuery(selectedNode).attr('data-mathtex');
	        }
	        
			var mathLiveUrl = editor.getParam("mathLiveUrl");
	        var mathLiveHtml = '<script src="' + mathLiveUrl + '"></script>';
			mathLiveHtml += '<math-field id="mathlive" virtual-keyboard-mode="onfocus" tabindex="-1" data-alloy-tabstop="true">' + data.latex + '</math-field>';
			
			var helpButton = coreTranslator().translate('help');
			var helpLink = editor.getParam("olatmatheditor_helpUrl" + o_getMainWin().o_info.locale);
			var helpHtml = "<div class='pull-right'><span class='o_chelp_wrapper'><a href='" + helpLink + "' class='o_chelp' target='_blank'><i class='mce-ico mce-i-help'> </i> " + helpButton + "</a></span></div>";
			
			var body = {
				type: 'panel',
				items: [
					{ name: 'helphints', type: 'htmlpanel', label: '',
				    	html:'<div style="width:100%;" class="help-block">' + translator().translate('olatmatheditor.latexGroupHelpHint') + '</div>'
					},
				    { name: 'help', type: 'htmlpanel', label: '', html: helpHtml },
					{ name: 'cortexLabel', type: 'label', label: translator().translate('olatmatheditor.mathLiveTitle'), items: [] },
					{ name: 'cortex', type: 'htmlpanel', label: '', html: mathLiveHtml },
				   	{ name: 'latex', type: 'textarea', label: translator().translate('olatmatheditor.latexGroupTitle') },
					{ name: 'hints', type: 'htmlpanel', label: '',
				    	html:'<div style="width:100%;" class="help-block">' + translator().translate('olatmatheditor.latexGroupHint') + '</div>'
					},
					{ name: 'previewLabel', type: 'label', label: translator().translate('olatmatheditor.previewGroupTitle'), items: [] },
				    { name: 'preview', type: 'htmlpanel', label: '',
				    	 html: '<iframe id="mathpreviewFormula" style="width: 100%; min-height: 50px;"></iframe>'
					}
				]
			};
			
			var win = editor.windowManager.open({
				title: translator().translate('olatmatheditor.formulaTabTitle'),
				size: 'medium',
				body: body,
				initialData: data,
				buttons: [
					{
						type: 'cancel',
						name: 'cancel',
						text: 'Cancel'
					},
					{
						type: 'submit',
						name: 'save',
						text: 'Save',
						primary: true
					}
		        ],
		        onChange: function(dialogApi) {
					var mf = document.getElementById('mathlive');
					mf.setValue(dialogApi.getData().latex, {suppressChangeNotifications: true});
					updatePreview(dialogApi);
				},
				onSubmit: function(dialogApi) {
					insertLatex(dialogApi, selectedNode);
				},
				onCancel: closeKeyboardLatex,
				onClose: closeKeyboardLatex
			});
			
			// add scripts to iframe
			var iframe = document.getElementById("mathpreviewFormula");
			var iframeWindow = iframe.contentWindow || iframe.contentDocument.document || iframe.contentDocument;
			var iframeDocument = iframeWindow.document;
			var iframeHead = iframeDocument.getElementsByTagName('head')[0];
			var iframeBody = iframeDocument.getElementsByTagName('body')[0];
			
			iframeWindow.MathJax = {
					tex: {
						inlineMath: [['$', '$'], ['\\(', '\\)']]
					},
					options: {
						enableMenu: false,
						processHtmlClass: 'tex2jax_process'
					}
				};
	
			var mathJaxUrl = editor.getParam("mathJaxUrl");
			var node = iframeWindow.document.createElement('script');
			node.src = mathJaxUrl + 'tex-mml-chtml.js';
			node.type = 'text/javascript';
			node.async = true;
			node.charset = 'utf-8';
			iframeHead.appendChild(node);
			
			function updatePreview(dialogApi) {
				var MathJax = iframeWindow.MathJax;
				var div = iframeBody.querySelector('div');
				if (!div) {
					div = iframeDocument.createElement('div');
					div.classList.add("math");
					iframeBody.appendChild(div);
					iframeBody.style.backgroundColor = "#fcfcfc";
				}
				
				var data = dialogApi.getData();
				var tex = data.latex;
				if(tex == null || tex.length == 0) {
					var emptyHtml = "<div class='o_empty_state' style='text-align: center;'><div class='o_empty_visual'><h2>&Sigma;</h2></div>";
					emptyHtml += "<h4 class='o_empty_msg' style='font-family: sans-serif;'>" + translator().translate('olatmatheditor.empty.title') + "</h4>";
					emptyHtml += "<div class='o_empty_hint' style='font-family: sans-serif;'>" + translator().translate('olatmatheditor.empty.hint') + "</div></div>";
					div.innerHTML = emptyHtml;
				} else {
					div.innerHTML = '$$' + tex + '$$';
					if (MathJax && MathJax.startup) {
						MathJax.startup.getComponents();
						MathJax.typeset();
					}
				}
			}
			
			var mathliveEl = document.getElementById('mathlive');
			mathliveEl.addEventListener('input',(ev) => {
    			var newData = {
    				latex: ev.target.value
    			}
    			win.setData(newData);
				updatePreview(win);
			});
			mathliveEl.addEventListener('focusout',(ev) => {
				// when navigating out of the mathlive, try to find the latex-textarea 
				// and set focus there (accessbility)
				try {
					var el = ev.target;
					var latexArea = el.closest('.tox-form').querySelector('textarea');
					latexArea.focus();
				} catch(e) {
					if(window.console) console.log(e);
				}
			});
			updatePreview(win);

			// Tiny set the focus, we override it
			setTimeout(function() {
				try {
					var mathliveEl = document.getElementById('mathlive');
					mathliveEl.focus();
					mathliveEl.executeCommand('moveToMathFieldEnd');
					mathliveEl.shadowRoot.querySelector('.ML__virtual-keyboard-toggle').classList.add('is-visible');
				} catch(e) {
					if(window.console) console.log(e);
				}
			}, 333);
		}
		
		editor.on('init', function() {
			if (editor.settings.content_css !== false) {
				editor.dom.loadCSS(url + "/css/content.css");
			}

		    var scripts = editor.getDoc().getElementsByTagName('script');

			// check if script have already loaded
			var id = editor.dom.uniqueId();
			var mathJaxUrl = editor.getParam("mathJaxUrl") + 'tex-mml-chtml.js';
			var script = editor.dom.create('script', { id: id, type: 'text/javascript', src: mathJaxUrl });
			var found = false;
			for (var j = 0; j < scripts.length; j++) {
				if (scripts[j].src == script.src) {
					found = true;
					break;
				}
			}
			// load script
			if (!found) {
				editor.getDoc().defaultView.MathJax = {
					tex: {
						inlineMath: [['$', '$'], ['\\(', '\\)']]
					},
					options: {
						enableMenu: false,
						processHtmlClass: 'tex2jax_process'
					}
				};
				editor.getDoc().getElementsByTagName('head')[0].appendChild(script);
			}
		});
		
		// add dummy tag on set content
		editor.on('BeforeSetContent', function (e) {
			var div = editor.dom.create('div');
			div.innerHTML = e.content;
			var elements = div.querySelectorAll('.math');
			for (var i = 0 ; i < elements.length; i++) {
				checkElement(elements[i]);
			}
			e.content = div.innerHTML;
		});

		// refresh mathjax on set content
		editor.on('SetContent', function(e) {
			if (editor.getDoc().defaultView.MathJax && typeof editor.getDoc().defaultView.MathJax.startup !== "undefined") {
				editor.getDoc().defaultView.MathJax.startup.getComponents();
				editor.getDoc().defaultView.MathJax.typeset();
			} else {
				setTimeout(function() {
					if (editor.getDoc() != null
							&& editor.getDoc().defaultView.MathJax
							&& typeof editor.getDoc().defaultView.MathJax.startup !== "undefined") {
						editor.getDoc().defaultView.MathJax.startup.getComponents();
						editor.getDoc().defaultView.MathJax.typeset();
					}
				}, 2000);
			}
		});
		
		editor.on('click', function(e) {
			if (jQuery(e.target).closest(".math").length > 0) {
				showDialog();
			}
		});

        /** 
          * This onPreProcess handler is used to remove the dummy tags and bring back the
          * &lt;span class="math"&gt; tags when saving the document.
          */
		editor.on('PreProcess',function(e, format) {
			jQuery('span.math', e.node).each(function(idx, elm) {
				var span = editor.dom.create("span", {
					"class": "math",
					title : elm.title
				}, jQuery(elm).attr('data-mathtex'));
				editor.dom.replace(span, elm);
			});
		});

		// Register plugin button
		editor.ui.registry.addToggleButton('olatmatheditor', {
			icon : 'oo-sigma',
			tooltip : translator().translate('olatmatheditor.desc'),
			onAction: showDialog,
			onSetup: function (buttonApi) {
				var selection = editor.selection;
				buttonApi.setActive(isLatexElement(selection.getNode()));
				return selection.selectorChangedWithUnbind('span[data-mathtex]', buttonApi.setActive).unbind;
			}
		});
			
		editor.ui.registry.addMenuItem('olatmatheditor', {
			text : translator().translate('olatmatheditor.desc'),
			icon : 'oo-sigma',
			onAction: showDialog,
		});
	};
	
	function Plugin () {
		global$2.add('olatmatheditor', function (editor, url) {
			register(editor, url);
		});
    }

    Plugin();
})();
