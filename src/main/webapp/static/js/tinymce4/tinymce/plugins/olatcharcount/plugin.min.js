(function() {
    'use strict'; 
    
    var global$2 = tinymce.util.Tools.resolve('tinymce.PluginManager');
    var global = tinymce.util.Tools.resolve('tinymce.util.Delay');
	
	var cachedTrans;
			
	// Load the OLAT translator.
	function translator() {	
		if(cachedTrans) return cachedTrans;
		var mainWin = o_getMainWin();
		if (mainWin) {
			cachedTrans = jQuery(document).ooTranslator().getTranslator(mainWin.o_info.locale, 'org.olat.core.gui.components.form.flexible.impl.elements.richText.plugins.olatcharcount');
		} else {
			cachedTrans = {	translate : function(key) { return key; } }
		}
		return cachedTrans;
	}
	
	function getCharacterLength(editor) {
        var text = editor.getContent({format: 'html'});
        text = text.trim().replace(/(\n)+/g, " ");
        return text.length;
    }
	
    function updateCount(editor) {
		var count = getCharacterLength(editor);
		var label = translator().translate('olatcharcount.size') + "\u00A0";
		var text = label.replace("{0}", count);
		
		var charCount = jQuery('div.tox-statusbar__text-container div.o_char_count');
		if(charCount.length == 0) {
			jQuery('div.tox-statusbar__text-container').html('<div class="o_char_count">' + text + '</div>');
		} else {
			charCount.text(text);
		}
		var maxSize = editor.getParam("maxSize");
		if(count > maxSize) {
			jQuery('div.tox-statusbar').addClass('danger');
        } else {
			jQuery('div.tox-statusbar').removeClass('danger');
        }
    }
    
	var setup = function (editor, delay) {
		var debouncedUpdate = global.debounce(function () {
			return updateCount(editor);
		}, delay);
		editor.on('init', function () {
			updateCount(editor);
			global.setEditorTimeout(editor, function () {
				editor.on('SetContent BeforeAddUndo Undo Redo ViewUpdate keyup', debouncedUpdate);
			}, 0);
		});
    };

	function Plugin () {
		global$2.add('olatcharcount', function (editor, url) {
			setup(editor, 300);
			
			return {
				getMetadata: function () {
					return {
						name : 'OpenOlat character counter',
						author : 'frentix GmbH',
						authorurl : 'https://www.frentix.com',
						url : 'https://www.frentix.com',
						version : '2.0.0'
			     	};
			     }
			}
		});
    }

    Plugin();
})();