/**
 * 
 * 23.02.2010 stephane.rosse@frentix.com 
 */
(function() {
    'use strict'; 
    
    var global$2 = tinymce.util.Tools.resolve('tinymce.PluginManager');
    
	// Create plugin object
	var register = function (editor, url) {

		editor.on('keydown', function(e) {
			if (e == null || e.keyCode != 13 || !editor.selection.isCollapsed()) return;
			
			var focusEl = editor.selection.getNode();
			if(focusEl == null) return;

			if(detectQuote(focusEl)) {
				tinymce.dom.Event.cancel(e);
				split(focusEl);
			}
			
			function detectQuote(el) {
				var divQuote = editor.dom.getParent(el, 'DIV');
				var blockquote = editor.dom.getParent(el, 'BLOCKQUOTE');
				if(divQuote && blockquote && (divQuote.className == "b_quote_wrapper" || divQuote.className == "o_quote_wrapper")) {
					return true;
				}
				return false;
			}
			
			function split(focusEl) {
				//copy quote
				var parents = editor.dom.getParents(focusEl);
				var endQuote = '';
				var newQuote = '';
				for(var i=0; i<parents.length; i++) {
					var parent = parents[i];
					endQuote += '</' + parent.nodeName + '>'

					if(parent.className == "b_quote_wrapper" || parent.className == "o_quote_wrapper") {
						var quoteWrapper = '<div class="o_quote_wrapper"><div class="o_quote_author mceNonEditable">';
						for(var j=0; j<parent.childNodes.length; j++) {
							if(parent.childNodes[j].className == "o_quote_author mceNonEditable" || parent.childNodes[j].className == "b_quote_author mceNonEditable") {
								quoteWrapper += parent.childNodes[j].innerHTML;
								break;
							}
						}
						newQuote = quoteWrapper + '</div>' + newQuote;
						if(!detectQuote(parent)) {
							break;
						}
					} else {
						newQuote = '<' + parent.nodeName + ' class="' + parent.className + '">' + newQuote;
					}
				}

				var rawHtml = endQuote + '<p><span id="quote_spliter_marker"></span><br/></p>' + newQuote;
				editor.execCommand("mceInsertRawHTML", true, rawHtml);
				var marker = editor.dom.get('quote_spliter_marker');
				if (marker) {
					editor.selection.select(marker);
					editor.selection.collapse();
					editor.execCommand("mceRemoveNode", true, marker);
				}
			}
		});
	};
	
	function Plugin () {
		global$2.add('quotespliter', function (editor, url) {
			register(editor, url);
			
			return {
				getMetadata: function () {
					return {
						name : 'OpenOlat Quote Spliter',
						author : 'frentix GmbH',
						authorurl : 'http://www.frentix.com',
						url : 'http://www.frentix.com',
						version : "2.0.0"
			     	};
			     }
			}
		});
    }

    Plugin();
})();
